<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Reports</title>
    <link rel="icon" type="image/png" href="{% static 'images/sll2.png' %}" />
    <style>
      #workspace-button {
        transition: background-color 0.3s ease;
      }

      #workspace-button:hover {
        background-color: #d1d5db;
      }

      #workspace-button.active {
        background-color: #d1d5db;
      }

      #workspace-dropdown,
      #profile-dropdown {
        border: 1px solid #aaa;
      }

      .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* .active-link {
          background-color: #e2e8f0; 
      }

      .active-link:hover {
          background-color: #cbd5e0;
      } */

      @keyframes fade-in-down {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in-down {
        animation: fade-in-down 0.3s ease-out;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav
      class="bg-white fixed w-full text-black flex justify-between items-center border-b border-solid border-[#aaa] p-2 pl-0 pr-0 z-10"
    >
      <div class="flex items-center ml-2">
        <a href="{% url 'workspace' %}"
          ><img
            src="{% static 'images/sl.png' %}"
            alt="Logo"
            class="w-12 h-9 mr-4"
        /></a>
      </div>

      <!-- Inbox Icon -->
      <div class="relative">
        <a
          href="#"
          id="inbox-toggle"
          class="inbox-link relative flex right-[-47.5rem] text-gray-500 hover:text-[#2bdf78]"
        >
          <i class="bi bi-envelope-fill text-xl"></i>
          {% if unread_count > 0 %}
          <span
            class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center"
          >
            {{ unread_count }}
          </span>
          {% endif %}
        </a>

        <!-- Messenger like Sidebar -->
        <div
          id="inbox-sidebar"
          class="hidden fixed top-0 right-0 w-96 h-screen bg-white border-l border-gray-300 shadow-lg z-50 transition-transform transform translate-x-full flex flex-col"
        >
          <!-- sidebar preloader -->
          <div
            id="loader2"
            class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-10 h-10"
              viewBox="0 0 200 200"
            >
              <circle
                fill="#897F7B"
                stroke="#897F7B"
                stroke-width="15"
                r="15"
                cx="40"
                cy="65"
              >
                <animate
                  attributeName="cy"
                  calcMode="spline"
                  dur="2"
                  values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1"
                  repeatCount="indefinite"
                  begin="-.4"
                ></animate>
              </circle>
              <circle
                fill="#897F7B"
                stroke="#897F7B"
                stroke-width="15"
                r="15"
                cx="100"
                cy="65"
              >
                <animate
                  attributeName="cy"
                  calcMode="spline"
                  dur="2"
                  values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1"
                  repeatCount="indefinite"
                  begin="-.2"
                ></animate>
              </circle>
              <circle
                fill="#897F7B"
                stroke="#897F7B"
                stroke-width="15"
                r="15"
                cx="160"
                cy="65"
              >
                <animate
                  attributeName="cy"
                  calcMode="spline"
                  dur="2"
                  values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1"
                  repeatCount="indefinite"
                  begin="0"
                ></animate>
              </circle>
            </svg>
          </div>

          <!-- Header -->
          <div
            class="flex items-center justify-between p-4 border-b font-semibold text-lg bg-white sticky top-0 z-10"
          >
            <span id="chat-username">Messages</span>
            <button
              id="close-inbox-sidebar"
              class="text-gray-500 hover:text-red-500"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Message List -->
          <ul id="inbox-messages-list" class="overflow-y-auto flex-1 px-4 py-2">
            <!-- Conversations will load here via AJAX -->
          </ul>

          <div class="px-4 py-2 border-t bg-white text-right">
            <button id="compose-toggle-btn" class="inline-flex gap-1 text-sm text-blue-600 hover:underline">Send us a message <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-[1em] h-[1em] mt-[3px]">
              <path d="M4 22L20 12L4 2V10L16 12L4 14V22Z" />
            </svg>
            </button>
          </div>

          <div id="compose-message" class="hidden p-4 border-t bg-gray-50 mt-[-20px] h-full">
            <label for="recipient-select" class="block text-md font-medium mb-2 outline-none focus:ring-[#0e9272] focus:border-[#0e9272]">Select Recipient</label>
            <select id="recipient-select" class="w-full p-2 border border-gray-300 rounded-lg">
              <option value="">Select someone to help</option>
            </select>

            <label for="message-content" class="block text-md font-medium mt-4 mb-2">Message</label>
            <textarea id="message-content" class="w-full h-[20rem] p-2 border border-gray-300 rounded-lg" rows="4" placeholder="Write your message..."></textarea>

            <button id="send-message-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full cursor-pointer" disabled>Send</button>
          </div>

          <!-- Message Thread -->
          <div
            id="chat-thread"
            class="hidden flex-1 overflow-y-auto px-4 py-2 space-y-2 bg-gray-50"
          >
            <button
              onclick="backToInboxList()"
              class="text-sm text-blue-600 hover:underline"
            >
              ‚Üê Back
            </button>
            <!-- Messages will be dynamically loaded here -->
            <p class="text-sm text-gray-500 text-center">
              Select a conversation
            </p>
            <div
              id="typing-indicator"
              class="text-sm text-gray-500 italic px-4 py-1 hidden"
            >
              Typing...
            </div>
          </div>

          <!-- Message Input -->
          <form
            id="chat-form"
            class="hidden p-3 border-t flex items-center bg-white gap-2"
          >
            {% csrf_token %}
            <input
              type="text"
              id="chat-input"
              placeholder="Type a message..."
              class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
              autocomplete="off"
              style="
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
              "
            />
            <button
              type="submit"
              class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full"
            >
              Send
            </button>
          </form>
        </div>
      </div>

      <!-- Notification Bell -->
      <div class="relative">
        <button
          id="bell-button"
          class="relative flex right-[-24.1rem] text-gray-500 hover:text-[#2bdf78]"
        >
          <i class="bi bi-bell-fill text-xl"></i>
          <span
            id="pending-badge"
            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden"
          >
            0
          </span>
        </button>

        <!-- Dropdown -->
        <div
          id="notification-dropdown"
          class="absolute right-[-24.1rem] mt-2 w-72 bg-white border border-gray-200 rounded shadow-lg hidden"
        >
          <div class="p-4 border-b text-sm font-semibold text-gray-700">
            Notifications
          </div>
          <ul
            id="notification-list"
            class="max-h-60 overflow-y-auto text-sm divide-y divide-gray-100"
          >
            <li class="p-4 text-gray-500 text-center">Loading...</li>
          </ul>
        </div>
      </div>

      <!-- Profile Chip with Dropdown -->
      <div class="relative">
        <div
          class="flex items-center space-x-2 text-white p-2 rounded-full cursor-pointer profile-div mr-4"
          id="profile-button"
        >
          <!-- Avatar -->
          <div
            class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300"
          >
            {% with request.user.profile as my_profile %} {% if my_profile.get_profile_image %}
            <img
              src="{{ my_profile.get_profile_image }}"
              alt="User Avatar"
              class="w-full h-full object-cover"
            />
            {% else %}
            <span class="...">
              {{ request.user.first_name|slice:":1"|upper }}{{ request.user.last_name|slice:":1"|upper }}
            </span>
            {% endif %} {% endwith %}
          </div>
        </div>

        <!-- Dropdown Menu -->
        <div
          id="profile-dropdown"
          class="absolute right-0 hidden bg-white text-black rounded shadow-md w-48 z-10 p-1 mr-2"
        >
          <ul class="py-2">
            <li class="px-4 py-2 text-m text-black-600">
              <strong>{{ user.first_name }}</strong> <br />
              <span
                class="text-sm text-gray-500 truncate"
                style="max-width: 150px; display: inline-block"
              >
                {{ user.email }}
              </span>
            </li>
            <li>
              <a
                href="{% url 'account_settings' %}?next={{ request.path }}"
                class="block px-4 py-2 hover:bg-gray-200"
                >Account settings</a
              >
            </li>
            <li>
              <a
                href="{% url 'logout' %}"
                class="block px-4 py-2 hover:bg-gray-200"
                >Log Out</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="flex flex-1">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="bg-white text-black w-14 min-h-screen fixed mt-[4.08rem] p-4 transition-all duration-300 ease-in-out hover:w-52 group border-r border-solid border-[#aaa] group-hover:bg-white z-50"
      >
        <nav>
          <ul>
            <li
              class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer"
            >
              <a
                href="{% url 'workspace' %}"
                class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200"
              >
                <div class="flex-shrink-0">
                  <img
                    src="{% static 'images/left-arrow.png' %}"
                    alt=""
                    width="12"
                    height="14"
                  />
                </div>
                <span
                  class="absolute left-4 text-gray-400 text-sm opacity-0 group-hover:opacity-100 transition-all"
                >
                  Workspace
                </span>
              </a>
            </li>
            <li
              class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer"
            >
              <a
                href="{% url 'dashboard' %}"
                class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200"
                ><div class="flex-shrink-0">
                  <img
                    src="{% static 'images/dashboard.png' %}"
                    alt=""
                    width="18"
                    height="18"
                  />
                </div>
                <span
                  class="absolute left-4 opacity-0 group-hover:opacity-100 transition-all"
                >
                  Dashboard
                </span></a
              >
            </li>
            <li
              class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer"
            >
              <a
                href="{% url 'crop_details' %}"
                class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200"
                ><div class="flex-shrink-0">
                  <img
                    src="{% static 'images/info.png' %}"
                    alt=""
                    width="18"
                    height="18"
                  />
                </div>
                <span
                  class="absolute left-4 opacity-0 group-hover:opacity-100 transition-all"
                >
                  Crop_details
                </span></a
              >
            </li>
            <li
              class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer"
            >
              <a
                href="{% url 'reports' %}"
                class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200 "
                ><div class="flex-shrink-0">
                  <img
                    src="{% static 'images/bar-chart.png' %}"
                    alt=""
                    width="18"
                    height="18"
                  />
                </div>
                <span
                  class="absolute left-4 opacity-0 group-hover:opacity-100 transition-all"
                  >Reports
                </span></a
              >
            </li>
            <li
              class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer"
            >
              <a
                href="{% url 'dashboard_settings' %}"
                class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] hover:bg-gray-200 rounded space-x-2 active-link  {% if request.resolver_match.url_name == 'dashboard_settings' %} bg-gray-200 text-gray-800 font-semibold {% endif %}"
                ><div class="flex-shrink-0">
                  <img
                    src="{% static 'images/settings.png' %}"
                    alt=""
                    width="18"
                    height="18"
                  />
                </div>
                <span
                  class="absolute left-4 opacity-0 group-hover:opacity-100 transition-all"
                  >Settings
                </span></a
              >
            </li>
          </ul>
        </nav>
      </div>

      <!-- Main Content -->
      <div
        class="flex-1 p-6 mt-16 ml-14 group-hover:ml-52 transition-all duration-300 ease-in-out"
      >
        <!-- Crop Recommendation History Section -->
        <div class="mt-8">
          <h2 class="text-xl font-bold mb-4">Crop Recommendation History</h2>
          <!-- Filter Controls -->
          <div class="flex items-center gap-4 mb-4">
            <label for="filter-type" class="font-semibold">Filter by:</label>
            <select id="filter-type" class="border rounded p-2">
              <option value="day">Day</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
            <input type="date" id="filter-day" class="border rounded p-2" style="display:inline;">
            <input type="month" id="filter-month" class="border rounded p-2" style="display:none;">
            <input type="number" id="filter-year" class="border rounded p-2" min="2000" max="2100" placeholder="Year" style="display:none;">
            <button onclick="applyCropFilter()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Apply</button>
            <button onclick="exportToExcel()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Export to Excel</button>
          </div>
          <!-- Table for Crop History -->
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded">
              <thead>
                <tr>
                  <th class="py-2 px-4 border-b">Timestamp</th>
                  <th class="py-2 px-4 border-b">Crop</th>
                </tr>
              </thead>
              <tbody id="crop-history-table">
                <!-- Rows will be populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
      <script>
        // Parse crop history data from Django context
        let cropHistoryData = [];
        try {
          cropHistoryData = JSON.parse('{{ crop_history_json|escapejs }}');
        } catch (e) {
          cropHistoryData = [];
        }

        // Store the last filtered data for export
        let lastFilteredData = [];

        // Helper: format date to YYYY-MM-DD, YYYY-MM, or YYYY
        function formatDate(date, type) {
          const d = new Date(date);
          if (type === 'day') return d.toISOString().slice(0, 10);
          if (type === 'month') return d.toISOString().slice(0, 7);
          if (type === 'year') return d.getFullYear().toString();
          return '';
        }

        // Populate table with filtered data
        function populateCropTable(filteredData) {
          lastFilteredData = filteredData; // Save for export
          const table = document.getElementById('crop-history-table');
          table.innerHTML = '';
          if (filteredData.length === 0) {
            table.innerHTML = '<tr><td colspan="2" class="text-center py-4">No data found.</td></tr>';
            return;
          }
          filteredData.forEach(entry => {
            table.innerHTML += `
              <tr>
                <td class="py-2 px-4 border-b">${entry.timestamp}</td>
                <td class="py-2 px-4 border-b">${entry.crop}</td>
              </tr>
            `;
          });
        }

        // Filter logic
        function applyCropFilter() {
          const type = document.getElementById('filter-type').value;
          let filterValue = '';
          if (type === 'day') filterValue = document.getElementById('filter-day').value;
          if (type === 'month') filterValue = document.getElementById('filter-month').value;
          if (type === 'year') filterValue = document.getElementById('filter-year').value;
          if (!filterValue) {
            populateCropTable(cropHistoryData);
            return;
          }
          const filtered = cropHistoryData.filter(entry => {
            const entryDate = formatDate(entry.timestamp, type);
            return entryDate === filterValue;
          });
          populateCropTable(filtered);
        }

        // Export filtered data to Excel
        function exportToExcel() {
          if (!lastFilteredData || lastFilteredData.length === 0) {
            alert("No data to export.");
            return;
          }
          // Prepare worksheet data
          const ws_data = [
            ["Timestamp", "Crop"],
            ...lastFilteredData.map(entry => [entry.timestamp, entry.crop])
          ];
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "CropHistory");
          XLSX.writeFile(wb, "crop_recommendation_history.xlsx");
        }

        // Show/hide filter inputs based on filter type
        document.getElementById('filter-type').addEventListener('change', function() {
          document.getElementById('filter-day').style.display = this.value === 'day' ? 'inline' : 'none';
          document.getElementById('filter-month').style.display = this.value === 'month' ? 'inline' : 'none';
          document.getElementById('filter-year').style.display = this.value === 'year' ? 'inline' : 'none';
        });

        // Initial population
        document.addEventListener('DOMContentLoaded', function() {
          populateCropTable(cropHistoryData);
        });
      </script>

      <!-- Preloader -->
      <div
        id="loader"
        class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 200 200"
          class="w-20 h-20 animate-spin"
        >
          <radialGradient
            id="a9"
            cx=".66"
            fx=".66"
            cy=".3125"
            fy=".3125"
            gradientTransform="scale(1.5)"
          >
            <stop offset="0" stop-color="#0E9272"></stop>
            <stop offset=".3" stop-color="#0E9272" stop-opacity=".9"></stop>
            <stop offset=".6" stop-color="#0E9272" stop-opacity=".6"></stop>
            <stop offset=".8" stop-color="#0E9272" stop-opacity=".3"></stop>
            <stop offset="1" stop-color="#0E9272" stop-opacity="0"></stop>
          </radialGradient>
          <circle
            transform-origin="center"
            fill="none"
            stroke="url(#a9)"
            stroke-width="30"
            stroke-linecap="round"
            stroke-dasharray="200 1000"
            stroke-dashoffset="0"
            cx="100"
            cy="100"
            r="70"
          >
            <animateTransform
              type="rotate"
              attributeName="transform"
              calcMode="spline"
              dur="2"
              values="360;0"
              keyTimes="0;1"
              keySplines="0 0 1 1"
              repeatCount="indefinite"
            ></animateTransform>
          </circle>
          <circle
            transform-origin="center"
            fill="none"
            opacity=".2"
            stroke="#0E9272"
            stroke-width="30"
            stroke-linecap="round"
            cx="100"
            cy="100"
            r="70"
          ></circle>
        </svg>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const profileButton = document.getElementById("profile-button");
        const profileDropdown = document.getElementById("profile-dropdown");
        // const workspaceButton = document.getElementById("workspace-button");
        // const workspaceDropdown = document.getElementById("workspace-dropdown");
        const inboxToggle = document.getElementById("inbox-toggle");
        const inboxDropdown = document.getElementById("inbox-dropdown");
        const inboxSidebar = document.getElementById("inbox-sidebar");
        const loader = document.getElementById("loader");
        const sidebarLinks = document.querySelectorAll("#sidebar a");
        const composeMessageDiv = document.getElementById("compose-message");
        const recipientSelect = document.getElementById("recipient-select");
        const messageContent = document.getElementById("message-content");
        const sendMessageBtn = document.getElementById("send-message-btn");
        const composeBtn = document.getElementById("compose-toggle-btn");
        const bellButton = document.getElementById("bell-button");
        const bellDropdown = document.getElementById("notification-dropdown");

        let currentChatUserId = null;

        // Scroll to bottom of chat
        function scrollToBottom() {
          const chatThread = document.getElementById("chat-thread");
          if (chatThread) {
            chatThread.scrollTop = chatThread.scrollHeight;
          }
        }

        // Dropdown setup functions
        function hideAllDropdowns() {
          profileDropdown.classList.add("hidden");
          // workspaceDropdown.classList.add("hidden");
          bellDropdown.classList.add("hidden");
          if (inboxDropdown) inboxDropdown.classList.add("hidden");
        }

        function setupDropdown(button, dropdown, onOpenCallback) {
          if (!button || !dropdown) return;
          button.addEventListener("click", function (e) {
            e.stopPropagation();
            const isHidden = dropdown.classList.contains("hidden");
            hideAllDropdowns();
            if (isHidden) {
              // Apply the animation and make dropdown visible
              dropdown.classList.remove("hidden");
              dropdown.classList.add("animate-fade-in-down");
              setTimeout(
                () => dropdown.classList.remove("animate-fade-in-down"),
                300
              ); // Remove animation class after 300ms
            }
            if (typeof onOpenCallback === "function") {
              onOpenCallback();
            }
          });
        }

        // setupDropdown(workspaceButton, workspaceDropdown);
        setupDropdown(profileButton, profileDropdown);
        // setupDropdown(bellButton, bellDropdown, fetchPendingAccounts);
        setupDropdown(bellButton, bellDropdown);
        if (inboxToggle && inboxDropdown) {
          setupDropdown(inboxToggle, inboxDropdown);
        }

        document.addEventListener("click", function (e) {
          if (
            !profileButton.contains(e.target) &&
            !profileDropdown.contains(e.target) &&
            !bellButton?.contains(e.target) &&
            !bellDropdown?.contains(e.target) &&
            (!inboxToggle || !inboxToggle.contains(e.target)) &&
            (!inboxDropdown || !inboxDropdown.contains(e.target))
          ) {
            hideAllDropdowns();
          }
        });

        // fetchPendingAccounts(); // initial fetch
        // setInterval(fetchPendingAccounts, 5000);

        // async function fetchPendingAccounts() {
        //   const badge = document.getElementById("pending-badge");
        //   const list = document.getElementById("notification-list");

        //   try {
        //     const response = await fetch("/dashboard/pending-accounts/data/");
        //     const data = await response.json();

        //     // Update dropdown list (only if dropdown exists)
        //     if (list) {
        //       list.innerHTML = "";

        //       if (data.count > 0) {
        //         data.users.forEach((user) => {
        //           const li = document.createElement("li");
        //           li.className = "p-4 text-gray-700";
        //           li.textContent = `${user.username} (${user.email})`;
        //           list.appendChild(li);
        //         });
        //       } else {
        //         list.innerHTML = `<li class="p-4 text-gray-500 text-center">No pending accounts</li>`;
        //       }
        //     }

        //     // Update badge
        //     if (badge) {
        //       if (data.count > 0) {
        //         badge.classList.remove("hidden");
        //         badge.innerText = data.count;
        //       } else {
        //         badge.classList.add("hidden");
        //       }
        //     }
        //   } catch (error) {
        //     console.error("Error fetching users:", error);
        //     if (list) {
        //       list.innerHTML = `<li class="p-4 text-red-500 text-center">Failed to load</li>`;
        //     }
        //   }
        // }

        if (loader) {
          sidebarLinks.forEach((link) => {
            link.addEventListener("click", () => {
              loader.classList.remove("hidden");
            });
          });

          window.addEventListener("pageshow", () => {
            loader.classList.add("hidden");
          });
        }

        updateInboxDropdown();

        if (inboxToggle && inboxSidebar) {
          inboxToggle.addEventListener("click", function (e) {
            e.preventDefault();
            updateInboxDropdown();
            inboxSidebar.classList.remove("hidden", "translate-x-full");
          });
        }

        const closeBtn = document.getElementById("close-inbox-sidebar");
        if (closeBtn) {
          closeBtn.addEventListener("click", function () {
            inboxSidebar.classList.add("translate-x-full");
            setTimeout(() => {
              inboxSidebar.classList.add("hidden");
            }, 300);
          });
        }

        function updateInboxDropdown() {
          $.ajax({
            url: "{% url 'ajax_messages_status' %}",
            method: "GET",
            success: function (data) {
              const badge = $("#inbox-toggle span");
              const count = data.unread_count;

              if (count > 0) {
                if (badge.length > 0) {
                  badge.text(count);
                } else {
                  $("#inbox-toggle").append(`
                    <span class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
                      ${count}
                    </span>
                  `);
                }
              } else {
                badge.remove();
              }

              const inboxList = $("#inbox-messages-list");
              inboxList.empty();

              if (data.messages.length > 0) {
                const uniqueSenders = {};

                // Loop through messages to collect the latest message per sender
                data.messages.forEach((msg) => {
                  if (!uniqueSenders[msg.sender_id]) {
                    uniqueSenders[msg.sender_id] = msg;
                  }
                });

                Object.values(uniqueSenders).forEach((msg) => {
                  inboxList.append(`
                    <li class="p-2 border-b hover:bg-gray-100 cursor-pointer flex items-start space-x-2 rounded ${
                      msg.is_read ? "bg-white" : "bg-green-50"
                    }"
                        onclick="openMessage(${msg.sender_id}, '${
                    msg.sender
                  }')">
                      <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300 bg-gray-200 flex items-center justify-center text-sm font-semibold text-white">
                        ${
                          msg.sender_avatar
                            ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                            : `<span class="bg-gray-500 w-full h-full flex items-center justify-center">${msg.sender_initials}</span>`
                        }
                      </div>
                      <div class="flex flex-col w-full truncate text-ellipsis">
                        <div class="flex justify-between items-center">
                          <strong class="${
                            msg.is_read
                              ? "text-gray-600"
                              : "text-black font-semibold"
                          }">${msg.sender}</strong>
                          ${
                            msg.is_read
                              ? ""
                              : '<span class="text-xs text-green-600 font-semibold">‚Ä¢ New</span>'
                          }
                        </div>
                        <div class="text-sm text-gray-600 whitespace-nowrap overflow-hidden w-full truncate text-ellipsis">${
                          msg.content
                        }</div>
                        <small class="text-xs text-gray-400">${
                          msg.timestamp
                        }</small>
                      </div>
                    </li>
                  `);
                });
              } else {
                inboxList.html(
                  '<p class="flex flex-col items-center justify-center h-full min-h-[200px] text-center text-lg text-gray-500 p-3">No messages<br><span class="text-sm mt-1">Messages from the team will be shown here</span></p>'
                );
              }
            },
            error: function () {
              console.error("Failed to fetch messages");
            },
          });
        }

        window.openMessage = function (senderId, username) {
          currentChatUserId = senderId;
          $("#inbox-messages-list").addClass("hidden");
          $("#chat-thread").removeClass("hidden").empty();
          $("#chat-form").removeClass("hidden");
          $("#compose-toggle-btn").addClass("hidden");
          $("#chat-username").html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê Back</button>
            ${username}
          `);

          // Mark messages as read
          fetch(`/messages/mark_read/${senderId}/`)
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "ok") {
                // Refresh the dropdown to update UI (badge, background, dot)
                updateInboxDropdown();
              }
            });

          loadConversation(senderId);
        };

        window.backToInboxList = function () {
          currentChatUserId = null;
          $("#chat-thread").addClass("hidden").empty();
          $("#chat-form").addClass("hidden");
          $("#compose-message").addClass("hidden");
          $("#inbox-messages-list").removeClass("hidden");
          $("#chat-username").text("Messages");
          $("#compose-toggle-btn").removeClass("hidden");
        };

        function loadConversation(senderId) {
          const chatThread = $("#chat-thread");

          // Show preloader before loading content
          $("#loader2").removeClass("hidden");

          // Optional: clear chat thread for better transition
          chatThread.empty();

          // MutationObserver will monitor chatThread
          const observer = new MutationObserver((mutationsList, observer) => {
            if (chatThread.children().length > 0) {
              // Content added, hide the preloader
              $("#loader2").addClass("hidden");
              observer.disconnect(); // Stop observing
            }
          });

          // Start observing for child changes
          observer.observe(chatThread[0], { childList: true });

          $.ajax({
            url: `/messages/thread/${senderId}/`,
            method: "GET",
            success: function (data) {
              const chatThread = $("#chat-thread");
              chatThread.empty();

              if (data.messages && data.messages.length > 0) {
                // data.messages.forEach((msg) => {
                //   const isCurrentUser = msg.sender_id == currentUserId;

                //   if (isCurrentUser) {
                //     // Your message on the right
                //     chatThread.append(`
                //       <div class="flex justify-end">
                //         <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-green-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                //           <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                //           <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                //         </div>
                //       </div>
                //     `);
                //   } else {
                //     // Other user's message on the left
                //     const avatar = msg.sender_avatar
                //       ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                //       : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">üë§</div>`;

                //     chatThread.append(`
                //       <div class="flex items-start space-x-2 my-2">
                //         <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                //           ${avatar}
                //         </div>
                //         <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                //           <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                //           <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                //         </div>
                //       </div>
                //     `);
                //   }
                // });

                data.messages.forEach((msg) => {
                  if (msg.is_sender) {
                    // Message from current user
                    $("#chat-thread").append(`
                    <div class="flex justify-end">
                      <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-green-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;"">
                        <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                        <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                      </div>
                    </div>
                  `);
                  } else {
                    // Message from the other user
                    const avatar = msg.sender_avatar
                      ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                      : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">üë§</div>`;

                    $("#chat-thread").append(`
                    <div class="flex items-start space-x-2 my-2">
                      <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                        ${avatar}
                      </div>
                      <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                        <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                        <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                      </div>
                    </div>
                  `);
                  }
                });
              } else {
                chatThread.html(
                  '<p class="text-sm text-gray-500 text-center">No messages in this thread.</p>'
                );
                $("#loader").addClass("hidden"); // Still hide loader on failure
                observer.disconnect();
              }

              scrollToBottom();
            },
            error: function () {
              console.error("Failed to load conversation.");
              $("#chat-thread").html(
                '<p class="text-sm text-red-500 text-center">Could not load messages.</p>'
              );
            },
          });
        }

        const inboxSocket = new WebSocket(
          "ws://" + window.location.host + "/ws/inbox/"
        );
        inboxSocket.onmessage = function (e) {
          const data = JSON.parse(e.data);
          if (data.type === "new_message") {
            if (!currentUserId) {
              updateInboxDropdown();
            }

            const msg = data.message;
            if (
              currentChatUserId &&
              parseInt(currentChatUserId) === msg.sender_id
            ) {
              const isCurrentUser = msg.sender_id == currentUserId;

              if (isCurrentUser) {
                $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-green-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
              } else {
                const avatar = msg.sender_avatar
                  ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                  : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">üë§</div>`;
                console.log("Avatar URL: ", msg.sender_avatar);
                $("#chat-thread").append(`
                  <div class="flex items-start space-x-2 my-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                      ${avatar}
                    </div>
                    <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
              }

              // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
              scrollToBottom();
            } else {
              // If not in that thread, update inbox preview
              updateInboxDropdown();
            }
          }
        };

        inboxSocket.onopen = function () {
          console.log("WebSocket connected");
        };

        inboxSocket.onclose = function () {
          console.warn("WebSocket closed unexpectedly");
        };

        // SEND MESSAGE HANDLER
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");

        function getCSRFToken() {
          // return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
          const csrfTokenElement = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          );
          return csrfTokenElement ? csrfTokenElement.value : "";
        }

        if (chatForm) {
          chatForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message || !currentChatUserId) return;

            // Ensure CSRF token is correctly attached
            const csrfToken = getCSRFToken(); // Get the CSRF token
            if (!csrfToken) {
              console.error("CSRF token missing");
              return; // Don't proceed without CSRF token
            }

            fetch(`/messages/send/${currentChatUserId}/`, {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `message=${encodeURIComponent(message)}`,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "ok") {
                  $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-green-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${message}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${new Date().toLocaleTimeString(
                        [],
                        { hour: "2-digit", minute: "2-digit" }
                      )}</div>
                    </div>
                  </div>
                `);
                  chatInput.value = "";
                  // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
                  scrollToBottom();
                } else {
                  alert("Failed to send message");
                }
              })
              .catch((err) => {
                console.error("Send failed", err);
              });
          });
        }

        composeBtn.addEventListener("click", function () {
          // Hide inbox list and thread
          document.getElementById("inbox-messages-list").classList.add("hidden");
          document.getElementById("chat-thread").classList.add("hidden");
          document.getElementById("chat-form").classList.add("hidden");
          document.getElementById("compose-toggle-btn").classList.add("hidden");

          // Show compose form
          composeMessageDiv.classList.remove("hidden");

          // Reset form
          recipientSelect.value = "";
          messageContent.value = "";
          sendMessageBtn.disabled = true;

          // Optional: update header
          document.getElementById("chat-username").innerHTML = `
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê </button>
            Compose New Message
          `;
        });

        // Fetch admin users to populate the recipient select dropdown
        function loadAdminUsers() {
          fetch('/get_admin_users/')  // URL for the new view
            .then(response => response.json())
            .then(data => {
              const admins = data.admins;
              recipientSelect.innerHTML = '<option value="">Select one of our team to help you</option>';  // Reset dropdown

              admins.forEach(admin => {
                recipientSelect.innerHTML += `<option value="${admin.id}">${admin.username}</option>`;
              });
            })
            .catch(error => console.error("Error loading admin users:", error));
        }

        // Enable the send button if both recipient and message content are provided
        function checkFormValidity() {
          const recipientId = recipientSelect.value;
          const message = messageContent.value.trim();
          sendMessageBtn.disabled = !(recipientId && message);
        }

        // Listen for changes in the recipient or message content
        recipientSelect.addEventListener("change", checkFormValidity);
        messageContent.addEventListener("input", checkFormValidity);

        // Send the message when the button is clicked
        sendMessageBtn.addEventListener("click", function () {
          const recipientId = recipientSelect.value;
          const message = messageContent.value.trim();

          if (recipientId && message) {
            const csrfToken = getCSRFToken();  // Ensure CSRF token is attached

            fetch(`/messages/send/${recipientId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `message=${encodeURIComponent(message)}`
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'ok') {
                const recipientId = data.recipient_id || recipientSelect.value;
          const recipientUsername = recipientSelect.options[recipientSelect.selectedIndex].text;

          // Hide compose, show thread
          composeMessageDiv.classList.add("hidden");
          $('#inbox-messages-list').addClass('hidden');
          $('#chat-thread').removeClass('hidden').empty();
          $('#chat-form').removeClass('hidden');

          // Set current chat state
          currentChatUserId = recipientId;
          $('#chat-username').html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê Back</button>
            ${recipientUsername}
          `);

          // Load the conversation
          loadConversation(recipientId);
              } else {
                alert('Failed to send message');
              }
            })
            .catch(err => {
              console.error('Send failed', err);
            });
          }
        });

        // Load admin users when the page is loaded
        loadAdminUsers();
      });
    </script>

    <!-- preloader in sidebar link -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loader = document.getElementById("loader");
        const sidebarLinks = document.querySelectorAll("#sidebar a");
        const profileLinks = document.querySelectorAll("#profile-dropdown a");
        const dropdownLinks = document.querySelectorAll(
          "#workspace-dropdown a"
        );

        sidebarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            loader.classList.remove("hidden"); // Show the preloader
          });
        });

        profileLinks.forEach((link) => {
          link.addEventListener("click", () => {
            loader.classList.remove("hidden"); // Show the preloader
          });
        });

        dropdownLinks.forEach((link) => {
          link.addEventListener("click", () => {
            loader.classList.remove("hidden"); // Show the preloader
          });
        });
      });
    </script>

    <script>
      window.addEventListener("pageshow", function (event) {
        // Always hide the loader when coming back to this page
        const loader = document.getElementById("loader");
        if (loader) {
          loader.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
